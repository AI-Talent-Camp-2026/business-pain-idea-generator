<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - Pain-to-Idea Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/api.js?v=2"></script>
    <script src="assets/app.js?v=2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-12 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ–π
            </h1>
            <p class="text-gray-600">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 10 –º–∏–Ω—É—Ç.
            </p>
        </header>

        <!-- Status Card -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <!-- Current Stage -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:</h2>
                <div id="current-stage" class="text-2xl font-bold text-blue-600 mb-2">
                    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
                </div>
                <div id="stage-description" class="text-sm text-gray-600 italic">
                    –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...
                </div>
            </div>

            <!-- Progress Bar with Percentage -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span id="progress-percent" class="text-sm font-bold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden shadow-inner">
                    <div
                        id="progress-bar"
                        class="bg-gradient-to-r from-blue-500 to-blue-600 h-6 rounded-full transition-all duration-700 ease-out flex items-center justify-center text-xs text-white font-semibold relative overflow-hidden"
                        style="width: 0%"
                    >
                        <div class="absolute inset-0 bg-white opacity-20 animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="space-y-3">
                <div class="text-sm text-gray-600 mb-3">
                    <span class="font-medium">–ù–µ–¥–∞–≤–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                </div>
                <div id="recent-activity" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- Activity items will be added here -->
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 hidden">
            </div>
        </div>

        <!-- Info -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="font-semibold text-blue-900 mb-2">üí° –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</h3>
            <p class="text-sm text-blue-800">
                –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –≤—ã—è–≤–ª—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –±–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏ —Å –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º, –∞–Ω–∞–ª–æ–≥–∞–º–∏ –∏ –ø–ª–∞–Ω–∞–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
            </p>
        </div>
    </div>

    <!-- Live Logs Frame (–∫–∞–∫ —Ç–∏—Ç—Ä—ã) -->
    <div class="fixed bottom-0 left-0 right-0 h-48 bg-gradient-to-t from-gray-900 to-transparent pointer-events-none">
        <div id="logs-container" class="absolute bottom-0 left-0 right-0 h-full overflow-hidden">
            <div id="logs-scroll" class="text-sm font-mono text-green-400 p-4 space-y-1">
                <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>
        </div>
    </div>

    <style>
        @keyframes scroll-up {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-100%);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #logs-scroll {
            animation: scroll-up 30s linear infinite;
        }

        .log-line {
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            animation: fadeInUp 0.3s ease-out;
        }

        .log-line.success {
            color: #4ade80;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .log-line.error {
            color: #ef4444;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        #progress-bar {
            background: linear-gradient(
                90deg,
                #3b82f6 0%,
                #60a5fa 50%,
                #3b82f6 100%
            );
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        #current-stage {
            animation: fadeInUp 0.5s ease-out;
        }

        #recent-activity > div {
            animation: fadeInUp 0.4s ease-out;
        }

        /* Smooth transitions for all elements */
        * {
            transition: all 0.3s ease-out;
        }
    </style>

    <script>
        let logsEventSource = null;

        // Auto-start progress tracking when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const runId = getQueryParam('run_id');
            if (runId) {
                trackProgress(runId);
                startLiveLog(runId);
            } else {
                showError('–ù–µ —É–∫–∞–∑–∞–Ω ID –ø—Ä–æ–≥–æ–Ω–∞');
            }
        });

        function startLiveLog(runId) {
            const logsScroll = document.getElementById('logs-scroll');

            // Progress mapping based on log messages
            const progressMap = {
                'Starting generation': { percent: 5, stage: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', emoji: 'üöÄ' },
                'Connecting to OpenRouter': { percent: 10, stage: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI', emoji: 'üîå' },
                'Model:': { percent: 15, stage: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏', emoji: '‚öôÔ∏è' },
                'Analyzing pain signals': { percent: 25, stage: '–ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞–ª–æ–≤', emoji: 'üîç' },
                'Searching for user complaints': { percent: 35, stage: '–ü–æ–∏—Å–∫ –∂–∞–ª–æ–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', emoji: 'üìä' },
                'Identifying recurring pain': { percent: 45, stage: '–í—ã—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –±–æ–ª–µ–π', emoji: 'üéØ' },
                'Evaluating market segments': { percent: 55, stage: '–û—Ü–µ–Ω–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Ä—ã–Ω–∫–∞', emoji: 'üìà' },
                'Generating business ideas': { percent: 65, stage: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ–π', emoji: 'üí°' },
                'Brainstorming creative': { percent: 70, stage: '–ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —à—Ç—É—Ä–º', emoji: 'üß†' },
                'Searching for analogues': { percent: 75, stage: '–ü–æ–∏—Å–∫ –∞–Ω–∞–ª–æ–≥–æ–≤', emoji: 'üîé' },
                'Analyzing successful': { percent: 80, stage: '–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤', emoji: 'üèÜ' },
                'Creating validation': { percent: 85, stage: '–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤', emoji: '‚úì' },
                'Drafting 7-day': { percent: 90, stage: '–ü–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π', emoji: 'üìÖ' },
                'Drafting 30-day': { percent: 93, stage: '–ü–ª–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π', emoji: 'üìã' },
                'Finalizing idea': { percent: 96, stage: '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è', emoji: 'üé®' },
                'Successfully generated': { percent: 100, stage: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ!', emoji: '‚úÖ' },
                'Processing...': { percent: null, stage: '–û–±—Ä–∞–±–æ—Ç–∫–∞', emoji: '‚è≥' }
            };

            // Connect to logs stream
            logsEventSource = new EventSource(`${API_BASE_URL}/api/runs/${runId}/logs`);

            logsEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                // Create new log line
                const logLine = document.createElement('div');
                logLine.className = `log-line ${data.type || ''}`;

                const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();
                logLine.textContent = `[${timestamp}] ${data.message}`;

                // Add to logs
                logsScroll.appendChild(logLine);

                // Keep only last 20 lines
                while (logsScroll.children.length > 20) {
                    logsScroll.removeChild(logsScroll.firstChild);
                }

                // Update progress based on log message
                updateProgressFromLog(data.message);

                // Add to recent activity (if not DEBUG)
                if (!data.message.includes('[DEBUG]')) {
                    addRecentActivity(data.message, data.type);
                }
            };

            logsEventSource.onerror = function() {
                console.log('Logs stream closed');
                if (logsEventSource) {
                    logsEventSource.close();
                }
            };

            function updateProgressFromLog(message) {
                // Find matching progress info
                for (const [keyword, info] of Object.entries(progressMap)) {
                    if (message.includes(keyword)) {
                        if (info.percent !== null) {
                            updateProgress(info.percent, `${info.emoji} ${info.stage}`, message);
                        }
                        break;
                    }
                }
            }

            function updateProgress(percent, stage, description) {
                const progressBar = document.getElementById('progress-bar');
                const progressPercent = document.getElementById('progress-percent');
                const currentStage = document.getElementById('current-stage');
                const stageDescription = document.getElementById('stage-description');

                if (progressBar) {
                    progressBar.style.width = `${percent}%`;
                }
                if (progressPercent) {
                    progressPercent.textContent = `${percent}%`;
                }
                if (currentStage) {
                    currentStage.textContent = stage;
                }
                if (stageDescription) {
                    stageDescription.textContent = description;
                }
            }

            function addRecentActivity(message, type) {
                const activityContainer = document.getElementById('recent-activity');

                const activityItem = document.createElement('div');
                activityItem.className = `p-3 rounded-lg transition-all ${
                    type === 'success' ? 'bg-green-50 border border-green-200' :
                    type === 'error' ? 'bg-red-50 border border-red-200' :
                    'bg-blue-50 border border-blue-200'
                }`;

                activityItem.innerHTML = `
                    <div class="flex items-start">
                        <span class="mr-2 text-lg">
                            ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö°'}
                        </span>
                        <div class="flex-1">
                            <p class="text-sm font-medium ${
                                type === 'success' ? 'text-green-800' :
                                type === 'error' ? 'text-red-800' :
                                'text-blue-800'
                            }">${message}</p>
                            <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</p>
                        </div>
                    </div>
                `;

                // Add to top of list
                if (activityContainer.firstChild) {
                    activityContainer.insertBefore(activityItem, activityContainer.firstChild);
                } else {
                    activityContainer.appendChild(activityItem);
                }

                // Keep only last 5 items
                while (activityContainer.children.length > 5) {
                    activityContainer.removeChild(activityContainer.lastChild);
                }

                // Animate in
                activityItem.style.opacity = '0';
                activityItem.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    activityItem.style.transition = 'all 0.3s ease-out';
                    activityItem.style.opacity = '1';
                    activityItem.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (logsEventSource) {
                logsEventSource.close();
            }
        });
    </script>
</body>
</html>
